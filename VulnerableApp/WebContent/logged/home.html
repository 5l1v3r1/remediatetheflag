<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
.white, .white a {
	color: #fff;
}
.navbar-brand {
	cursor: default;
	color: #FFF;
    background-color: #18bc9c;;
}
.navbar-brand:hover {
    color: #FFF;
    background-color: #18bc9c;;
    cursor: default;
}
.dynatable-search {
	display: none !important;
}

.topLink {
	padding-left: 0px;
	padding-right: 0px;
	font-size: 13px;
}

.feedbackError {
	color: red;
	text-align: center;
	font-weight: bold;
}
</style>
</head>
<title>Vulnerable App</title>

<link href="/style/css/bootstrap.min.css" rel="stylesheet">

<body style="">

	<div class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span> <span class="icon-bar"></span>
				</button>

				<a class="navbar-brand" href="#">Vulnerable App</a>
			</div>
			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav">

					<li><a class="topLink"
						href="home.jsp?user=User&url=/logged/home.html%23profile">Home</a>
					</li>
					<li class="liLink active"><a class="link topLink"
						href="#documents">Documents</a></li>
					<li class="liLink "><a class="link topLink" href="#posts">Posts</a>
					</li>
					<li class="liLink"><a class="link topLink" href="#profile">Profile</a>
					</li>
					<li class="liLink"><a class="link topLink" href="#feedback">Website
							Feedback</a></li>
					<!-- <li><a target="_blank" disabled class="topLink"
						href="//www.vulnerableapp.com:8088/chat">Chat</a></li>-->
				</ul>
				<div class="btn-group pull-right">
					<button class="btn btn-info" id="logoutButton"
						style="margin-top: 7px;">
						<a class="glyphicon glyphicon-off white"></a>
					</button>
				</div>
			</div>
			<!--/.nav-collapse -->
		</div>
	</div>

	<div id="profile" class="container vContainer"
		style="margin-top: 60px; display: none;">
		<h2>Profile Informations</h2>
		<div style="margin-top: 15px;">
			<form class="form-horizontal" role="form">
				<div class="row">
					<div class="col-md-3">
					<label for="inputUsername">Username</label>
						<div class="form-group">
							<input type="text"
								class="form-control" name="inputUsername" id="inputUsername" placeholder="">
						</div>
					</div>
					<div class="col-md-3" style="margin-left:10px;">
					<label for="inputPassword">Password</label>
						<div class="form-group">
							 <input
								type="password" class="form-control" name="inputPassword" id="inputPassword"
								placeholder="******">
						</div>
					</div>
					<div class="col-md-3" style="margin-left:10px;">
					<label for="inputEmail">Email</label>
						<div class="form-group">
							 <input type="email"
								class="form-control" id="inputEmail" name="inputEmail" placeholder="">
						</div>
					</div>
				</div>
			</form>
			</br>
			<form class="form-horizontal" role="form">
				<div class="row">
					
					<div class="col-md-3">
<label for="inputProfession">Profession</label>
						<div class="form-group">
							 <input
								type="email" class="form-control" id="inputProfession"
								name="inputProfession" placeholder="">
						</div>
					</div>
				</div>
			</form>
			<br>
			<form class="form-horizontal" role="form" style="margin-top: 10px;">
				<div class="row">
					<div class="col-md-3" >
					<label for="inputCountry">Country</label> 
						<div class="form-group">
							<input type="text"
								class="form-control" name="inputCountry" id="inputCountry" placeholder="">
						</div>
					</div>
					<div class="col-md-3" style="margin-left:10px;">
					<label for="inputCity">City</label>
						<div class="form-group">
							 <input type="text"
								class="form-control" name="inputCity" id="inputCity" placeholder="">
						</div>
					</div>
				</div>
			</form>
			<br> <a id="saveProfileInfo" type="submit"
				class="btn btn-primary btn-lg" style="margin-left: 20px;">Save</a>

			<!--

 -->

		</div>

	</div>
	<!-- /.container -->

	<div id="documents" class="container vContainer"
		style="margin-top: 80px;">

		<div class="col-md-12">
			<div class="row">
				<div class="col-md-4" style="padding-left: 0px;">
					<h2
						style="margin-bottom: 25px; margin-top: 0px; display: inline-block;">My
						Documents</h2>
					<ul class="list-group" style="margin-left: 10px;" id="filesList">

					</ul>
					<div style="margin-top: 10px; display: none;" class="form-group">
						<label for="inputFile">File input</label> <input type="file"
							id="inputFile">
					</div>
				</div>
				<div class="col-md-8">
					<div style="margin-bottom: 25px;">
						<div class="col-xs-6" style="padding-left: 0px;">
							<input id="fileToOpen" type="text" class="form-control col-xs-4"
								placeholder="indicate filename">
						</div>
						<button style="margin-left: 10px;" class="btn btn-success btn-sm"
							id="openFile">Open</button>
					</div>
					<textarea id="docOutput" style="resize: none;" class="form-control"
						rows="10"></textarea>
				</div>
			</div>
			<div class="row">
				<div class="col-md-8" style="padding-left: 0px;">
					<h4>Upload a Document:</h4>
					<form id="uploadForm" style="margin-top: 40px;">
						<input id="filePath" type="file" name="datafile" size="40"><br>
						<button type="submit" style="margin-top: 5px;"
							class="btn btn-primary btn-sm" id="upFile">Upload</button>
					</form>

				</div>
			</div>
		</div>
	</div>

	<div id="feedback" class="container vContainer"
		style="display: none; margin-top: 80px;">

		<div class="col-md-12">
			<div class="row">
				<div class="col-md-4" style="padding-left: 0px;">
					<h2
						style="margin-bottom: 25px; margin-top: 0px; display: inline-block;">Website
						Feedback</h2>
					<div style="margin-bottom: 25px;">
						<div class="col-xs-12" style="padding-left: 0px;">
							<input id="userFeedbacks" type="text" class="form-control"
								placeholder="type a username (e.g. user)">
						</div>
						<div>
							<button style="margin-top: 15px;" class="btn btn-primary btn-sm"
								id="showFeedbacks">Filter</button>
						</div>
					</div>
				</div>
				<div class="col-md-8">
					<table id="feedbackTable"
						class="table table-striped table-bordered">
						<thead>
							<tr>
								<th style="width: 8%;">User</th>
								<th style="width: 22%;">Date</th>
								<th>Message</th>
							</tr>
						</thead>
						<tbody id="feedbackContent">

						</tbody>
					</table>
					<div id="feedbacksErrorOut" style="display: none;">
						<p class="lead feedbackError">An error occurred, please try
							again.</p>
					</div>
					<div id="feedbacksEmptyOut" style="display: none;">
						<p class="lead feedbackError">No results found, please try
							again.</p>

					</div>
				</div>

			</div>
			<div class="row">
				<div class="col-md-8" style="padding-left: 0px;">
					<h4>Add Feedback</h4>
					<textarea id="newFeedback" placeholder="type a message" cols="50"></textarea>
					</br>
					<button style="margin-top: 15px;" class="btn btn-success btn-sm"
						id="storeFeedbackButton">Store</button>
				</div>
			</div>
		</div>
	</div>


	<div id="posts" class="container vContainer"
		style="margin-top: 80px; display: none;">

		<div class="col-md-12">
			<div class="row">
				<div class="col-md-4" style="padding-left: 0px;">
					<h2
						style="margin-bottom: 25px; margin-top: 0px; display: inline-block;">My
						Posts</h2>
					<ul class="list-group" style="margin-left: 10px;" id="postsList">

					</ul>
					<div style="margin-top: 10px; display: none;" class="form-group">
						<label for="inputFile">File input</label> <input type="file"
							id="inputPost">
					</div>
				</div>
				<div class="col-md-8">
					<div style="margin-bottom: 25px;">
						<div class="col-xs-6" style="padding-left: 0px;">
							<input id="postToOpen" type="text" class="form-control col-xs-4"
								placeholder="indicate filename">
						</div>
						<button style="margin-left: 10px;" class="btn btn-success btn-sm"
							id="openPost">Open</button>
					</div>
					<textarea id="postOutput" style="resize: none;"
						class="form-control" rows="10"></textarea>
				</div>
			</div>
			<div class="row">
				<div class="col-md-8" style="padding-left: 0px;">
					<h4>Add a Post:</h4>
					<div>
						<input id="postTitle" type="text" placeholder="type title"></br>
						<textarea id="postContent" style="margin-top: 10px;"
							placeholder="type content" cols="50"></textarea>
					</div>
					<div>
						<button style="margin-top: 15px;" class="btn btn-primary btn-sm"
							id="storePost">Store</button>
					</div>
				</div>
			</div>
		</div>
	</div>



	<div id="footer">
		<hr>
		<div class="container">

			<!--	<p>Â© Vulnerable App 2016</p>-->
		</div>
	</div>
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/jquery.dynatable.js"></script>
	<script>
		$(document)
				.ready(

						function() {

							var files;
							$('input[type=file]').on('change', prepareUpload);
							function prepareUpload(event) {
								files = event.target.files;
								console.log(files);
							}
							$('#uploadForm').on('submit', uploadFiles);

							function uploadFiles(event) {
								event.stopPropagation();
								event.preventDefault();

								// START A LOADING SPINNER HERE

								var data = new FormData();
								$.each(files, function(key, value) {
									data.append(key, value);
								});

								$
										.ajax({
											url : '/logged/uploadHandler',
											type : 'POST',
											data : data,
											cache : false,
											dataType : 'json',
											processData : false,
											contentType : false,
											complete : function(data,
													textStatus, jqXHR) {
												$('#uploadTitle').hide();
												$('#uploadForm').hide();
												$('#fileUploaded').show();
												$('#filePath').val("");
												getDocs();
												window.setTimeout(function() {
													$('#fileUploaded').hide();
													$('#uploadTitle').show();
													$('#uploadForm').show();
												}, 5000);
											}
										});
							}

							var token = "";

							function getCSRFToken() {
								var action = {};
								action.type = "token";
								var dataString = JSON.stringify(action);
								var url = "/logged/userHandler";
								$.post(url, dataString, function(obj) {
									token = obj.token;
								}, "json");
							}
							//getCSRFToken();

							function locationHashChanged() {
								var href = location.hash.substr(1);
								$('.vContainer').hide();
								$('#' + href).show();
								$('.liLink').removeClass('active');
								$('a[href=' + location.hash + ']').parent()
										.addClass('active');
							}

							window.onhashchange = locationHashChanged;
							locationHashChanged();
							/*
								$('.link').on('click', function(e) {
									e.preventDefault();
									var href = $(this).attr('href');
									$('.vContainer').hide();
									$('#' + href).show();
									$('.liLink').removeClass('active');
									$(this).parent().addClass('active');
								})
							 */
							var profileInfos = "{\"type\":\"userProfileInfo\"}";
							var url = "/logged/userHandler";
							var profileObj = null;

							$.post(url, profileInfos, function(obj) {
								profileObj = $.parseJSON(obj);
								viewProfileInfos(profileObj);
							});

							$('#saveProfileInfo').click(function() {
								storeUserProfileInfos();
							});

							$('#storePost')
									.on(
											'click',
											function(e) {
												e.preventDefault();
												var title = $('#postTitle')
														.val();
												var url = "/logged/userHandler";
												var content = $('#postContent')
														.val();
												var ts = new Date().getTime();
												var obj = {};

												var xml = '<?xml version="1.0" encoding="utf-8" standalone="no"?><Post><title>'
														+ title
														+ '</title><content>'
														+ content
														+ '</content><timestamp>'
														+ ts
														+ '</timestamp></Post>';
												obj.type = "storePost";
												obj.xml = xml;
												obj.title = title;
												$.post(url,
														JSON.stringify(obj),
														function(res) {
															if (res == "ok") {
																getPosts();
															}
														});
											});

							function viewProfileInfos(obj) {

								if (obj.username !== null)
									$('#inputUsername').val(obj.username);
								if (obj.email !== null)
									$('#inputEmail').val(obj.email);
								if (obj.city !== null)
									$('#inputCity').val(obj.city);
								if (obj.country !== null)
									$('#inputCountry').val(obj.country);
								if (obj.work !== null)
									$('#inputProfession').val(obj.work);
							}

							function storeUserProfileInfos() {

								var usrV = $('#inputUsername').val();
								if (usrV)
									usr = "\"" + usrV + "\"";
								else
									usr = null;

								var cityV = $('#inputCity').val();
								if (cityV)
									city = "\"" + cityV + "\"";
								else
									city = null;

								var countryV = $('#inputCountry').val();
								if (countryV)
									country = "\"" + countryV + "\"";
								else
									country = null;

								var workV = $('#inputProfession').val();
								if (workV)
									work = "\"" + workV + "\"";
								else
									work = null;

								var emailV = $('#inputEmail').val();
								if (emailV)
									email = "\"" + emailV + "\"";
								else
									email = null;

								var passwordV = $('#inputPassword').val();
								if (passwordV)
									password = "\"" + passwordV + "\"";
								else
									password = null;

								var dataString = "{\"type\":\"changeProfileInfo\",\"token\":\""
										+ token
										+ "\",\"username\":"
										+ usr
										+ ",\"password\":"
										+ password
										+ ",\"city\":"
										+ city
										+ ",\"country\":"
										+ country
										+ ",\"work\":"
										+ work
										+ ",\"email\":" + email + "}";
								var url = "/logged/userHandler";
								$
										.post(
												url,
												dataString,
												function(obj) {
													if (obj.type == "profileInfoChanged") {
														$('#saveProfileInfo')
																.text("Saved");
														$('#saveProfileInfo')
																.addClass(
																		"disabled");
														window
																.setTimeout(
																		"$('#saveProfileInfo').removeClass('disabled');$('#saveProfileInfo').text('Save');",
																		3500);
													}
												}, "json");
							}
						});

		function getDocs() {
			var url = "/logged/userHandler";
			var dataString = '{"type":"getDocs","kind":"check"}';
			$.post(url, dataString, function(obj) {
				var datas = obj.split("\n");
				var tba = "";
				for (var i = 0; i < datas.length; i++) {
					if (datas[i] !== "") {
						tba += '<li class="list-group-item">' + datas[i]
								+ '</li>';
					}
				}
				$('#filesList').empty();
				$('#filesList').append(tba);
			});
		}

		function getPosts() {
			var url = "/logged/userHandler";
			var dataString = '{"type":"getPosts","kind":"list"}';
			$.post(url, dataString, function(obj) {
				var datas = obj.split("\n");
				var tba = "";
				for (var i = 0; i < datas.length; i++) {
					if (datas[i] !== "") {
						tba += '<li class="list-group-item">' + datas[i]
								+ '</li>';
					}
				}
				$('#postsList').empty();
				$('#postsList').append(tba);
			});
		}
		getPosts();
		getDocs();
		$('#openFile')
				.click(
						function(e) {
							e.preventDefault();
							var url = "/logged/userHandler";
							var filename = $('#fileToOpen').val();
							var dataString = '{"type":"getDocs","kind":"open","filename":"'
									+ filename + '"}';
							$.post(url, dataString, function(obj) {
								$('#docOutput').empty();
								$('#docOutput').append(obj);
							});
						});

		$('#documents').on('click', '.list-group-item', function(e) {
			e.preventDefault();
			$('#fileToOpen').val($(this).text());
		});

		$('#openPost')
				.click(
						function(e) {
							e.preventDefault();
							var url = "/logged/userHandler";
							var filename = $('#postToOpen').val();
							var dataString = '{"type":"getPosts","kind":"open","file":"'
									+ filename + '"}';
							$.post(url, dataString, function(obj) {
								$('#postOutput').empty();
								obj = JSON.parse(obj);
								var d = new Date(parseInt(obj.timestamp));
								var s = "Title:\t\t" + obj.title
										+ "\nContent:\t" + obj.content
										+ "\nDate:\t" + d;
								$('#postOutput').append(s);
							});
						});

		$('#posts').on('click', '.list-group-item', function(e) {
			e.preventDefault();
			$('#postToOpen').val($(this).text());
		});

		$('#logoutButton').click(function(e) {
			e.preventDefault();
			window.location = '/auth';
		});

		function storeFeedback() {
			var add = "/logged/userHandler";
			var msg = $('#newFeedback').val();
			var action = "{\"type\":\"storeFeedback\",\"msg\":\"" + msg + "\"}";
			$.post(add, action, function(obj) {
				$('#newFeedback').val("");
				loadFeedbacks();
			});
		}
		$('#storeFeedbackButton').on('click', function(e) {
			e.preventDefault();
			storeFeedback();
		});

		function loadFeedbacks() {
			var add = "/logged/userHandler";
			var usr = $('#userFeedbacks').val();
			var action = "{\"type\":\"getFeedbacks\",\"kind\":\"all\"}";
			$.post(
					add,
					action,
					function(obj) {
						$('#feedbacksErrorOut').hide();
						$('#feedbacksEmptyOut').hide();
						$('#feedbackContent').empty();

						var f = 0;
						if (obj.feedbacks.length == 1) {
							$('#feedbacksEmptyOut').show();
						}
						for (var i = 0; i < obj.feedbacks.length - 1; i++) {
							f++;
							var a = new Date(obj.feedbacks[i].date);
							var dstring = a.toLocaleDateString("en-gb") + " - "
									+ a.getHours() + ":" + a.getMinutes()
							$('#feedbackContent').append("<tr id=\"" + f + "\"><td>"
											+ obj.feedbacks[i].usr
											+ "</td><td>" + dstring
											+ "</td><td>"
											+ obj.feedbacks[i].msg
											+ "</td></tr>");
						}
						$('#feedbackTable').dynatable({
							features : {
								paginate : false,
								recordCount : false,
								pushState : false
							}
						});
						$('#feedbackTable').show();
					}, "json").fail(function(xhr, status, error) {
				$('#feedbackContent').empty();
				$('#feedbacksErrorOut').show();
				$('#feedbacksEmptyOut').hide();
			});

		}
		loadFeedbacks();

		$('#showFeedbacks')
				.click(
						function(e) {
							var add = "/logged/userHandler";
							var usr = $('#userFeedbacks').val();
							var action = "{\"type\":\"getFeedbacks\",\"kind\":\"search\",\"usr\":\""
									+ usr + "\"}";
							$
									.post(
											add,
											action,
											function(obj) {
												$('#feedbacksErrorOut').hide();
												$('#feedbacksEmptyOut').hide();
												$('#feedbackContent').empty();

												var f = 0;
												if (obj.feedbacks.length == 1) {
													$('#feedbacksEmptyOut')
															.show();
												}
												for (var i = 0; i < obj.feedbacks.length - 1; i++) {
													f++;
													$('#feedbackContent')
															.append(
																	"<tr id=\"" + f + "\"><td><a href=\"\">"
																			+ obj.feedbacks[i].usr
																			+ "</a></td><td>"
																			+ obj.feedbacks[i].date
																			+ "</td><td>"
																			+ obj.feedbacks[i].msg
																			+ "</td></tr>");
												}
												$('#feedbackTable').dynatable({
													features : {
														paginate : false,
														recordCount : false,
														pushState : false
													}
												});
												$('#feedbackTable').show();
											}, "json").fail(
											function(xhr, status, error) {
												$('#feedbackContent').empty();
												$('#feedbacksErrorOut').show();
												$('#feedbacksEmptyOut').hide();
											});
						});
	</script>


</body>

</html>