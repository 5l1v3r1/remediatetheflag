<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Remediate the Flag - Results Renderer</title>

<link rel="stylesheet" href="style/css/github.min.css">
<link rel="stylesheet" href="style/css/diff2html.min.css">
<link rel="stylesheet" href="style/css/bootstrap.min.css">
<!-- Javascripts -->
<script src="js/jquery.js"></script>
<script src="js/highlight.min.js"></script>
<script type="text/javascript" src="js/diff2html.min.js"></script>
<script type="text/javascript" src="js/diff2html-ui.min.js"></script>
<script type="text/javascript" src="js/zip.js"></script>

</head>

<style>
html, body {
	height: 100%;
}

#vulnerabilitiesTable{
	margin-bottom:0px;
	margin-top: 5px;
}
.jumbotron p {
    margin-bottom: 0px;
    font-size: 16px;
}
#vulnerabilitiesTable>thead>tr>th, #vulnerabilitiesTable>tbody>tr>th, #vulnerabilitiesTable>tfoot>tr>th, #vulnerabilitiesTable>thead>tr>td, #vulnerabilitiesTable>tbody>tr>td, #vulnerabilitiesTable>tfoot>tr>td {
    padding-bottom: 4px !important;
    padding-left: 10px;
    padding-top: 4px !important;
    vertical-align:middle;
}
.navbar-brand {
	cursor: default;
	color: #FFF;
	background-color: #18bc9c;;
}

.navbar-brand:hover {
	color: #FFF;
	background-color: #18bc9c;;
	cursor: default;
}

table>thead>tr>th, .table>tbody>tr>th, .table>tfoot>tr>th, .table>thead>tr>td,
	.table>tbody>tr>td, .table>tfoot>tr>td {
	padding: 2px;
	padding-left: 10px;
}

.thead-default {
	background: rgba(204, 204, 204, 0.75);
}

.navbar-brand:hover {
	color: #18bc9c;
	background-color: transparent;
}

#wrap {
	min-height: 100%;
	height: auto;
	margin: 0 auto -80px;
	padding: 0 0 80px;
}

hr {
	border-color: #000;
}

.jumbotron {
	background-color: #FFF;
	padding-bottom: 0px;
	margin-bottom: 0px;
	padding-top: 60px;
}
</style>

</head>
<body>

	<div class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">RTF - Results Renderer</a>
			</div>
			<div class="navbar-collapse collapse"></div>
			<!--/.navbar-collapse -->
		</div>
	</div>
	<div id="wrap">
		<!-- Main jumbotron for a primary marketing message or call to action -->
		<div class="jumbotron" >
			<div class="container">
				<div class="row" id="uploadArea">
					<div class="col-md-6">
						<h1>Hello!</h1>
						<p>Upload a results zip file to start analysis.</p>
						<div id="upload" style="margin-top:10px;">
							<input type="file" accept="application/zip" id="file-input">
						</div>
		
						

					</div>
				</div>
				<div id="infoArea" class="row" style="display:none;">
					<div class="col-md-6">
						<h2>Instance Id: </h2><p id="instanceIdText" class="lead"></p>
						<h2>Instance IP: </h2><p id="instanceIpText" class="lead"></p>
						</br>
						<button id="viewLogsButton" class="btn btn-large btn-primary">Show Instance Logs</button>
						<button id="viewDiffButton" style="display:none;" class="btn btn-large btn-primary">Show Source Code Diff</button>
						
					</div>
					<div class="col-md-6">
					<h2>Self-Check Script Results:</h2>
						<table class="table table-bordered table-stripes" id="vulnerabilitiesTable">
							<thead class="thead-default">
								<tr><td><p style="font-weight:bold">Vulnerability</p></td><td><p style="font-weight:bold">Status</p></td></tr>
							</thead>
							<tbody id="vulnTable">
							
							</tbody>
						</table>
					</div>
				</div>
				<div id="diffDiv" class="row" style="display:none;margin-top: 25px;">
					<h2>Source Code Diff:</h2>
					<div class="col-md-12">
						<div id="targetDiv"></div>
					</div>
				</div>
				<div id="logArea" class="row" style="display:none;margin-top: 25px;">
					<h2>Instance Logs:</h2>
					<div class="col-md-12">
						<div id="rtfLogText"></div>
					</div>
				</div>
				
			</div>

		</div>
		

	</div>

<script>
zip.workerScriptsPath = "js/zip/";
var rtfLog = "";

function htmlEncode(value){
	  //create a in-memory div, set it's inner text(which jQuery automatically encodes)
	  //then grab the encoded contents back out.  The div never exists on the page.
	  return $('<div/>').text(value).html();
	}

(function(obj) {

	var requestFileSystem = obj.webkitRequestFileSystem || obj.mozRequestFileSystem || obj.requestFileSystem;

	function onerror(message) {
		alert(message);
	}

	var model = (function() {
		var URL = obj.webkitURL || obj.mozURL || obj.URL;

		return {
			getEntries : function(file, onend) {
				zip.createReader(new zip.BlobReader(file), function(zipReader) {
					zipReader.getEntries(onend);
				}, onerror);
			},
			getEntryFile : function(entry, creationMethod, onend, onprogress) {
				var writer, zipFileEntry;

				function getData() {
					entry.getData(writer, function(blob) {
						
						//var blobURL = URL.createObjectURL(blob);
						
						onend(blob);
					}, onprogress);
				}
				writer = new zip.BlobWriter();
				getData();
			}
		};
	})();

	(function() {
		var fileInput = document.getElementById("file-input");
		var unzipProgress = document.createElement("progress");
		var fileList = document.getElementById("file-list");
		var creationMethodInput = 'Blob';

		function renderZippedFile(entry) {
			model.getEntryFile(entry, creationMethodInput.value, function(blob) {
				var reader = new FileReader();
				var fileName = entry.filename;
				reader.onloadend = (function(theFile,fileName) {
					
					switch(fileName){
					case '/home/rtf/Desktop/RTF/sourceDiff.txt':
						return function(e) {
							var diffString = e.target.result;
							var diff2htmlUi = new Diff2HtmlUI(
									{
										diff : diffString
									});
							diff2htmlUi
									.draw(
											'#targetDiv',
											{
												inputFormat : 'diff',
												showFiles : true,
												matching : 'lines'
											});
							diff2htmlUi
									.highlightCode('#targetDiv');
							$('#uploadArea').hide();
							$('#logArea').hide();
							$('#showDiffButton').hide();
							$('#viewLogsButton').show();
							$('#diffDiv').show();
							$('#infoArea').show();
						};
					case '/home/rtf/Desktop/RTF/instanceInfo.txt':
						return function(e){
							var resultString = e.target.result;
							var instanceId = resultString.split('\n')[0].split(':')[1];
							var instanceIp = resultString.split('\n')[1].split(':')[1];
							$('#instanceIdText').text(instanceId);
							$('#instanceIpText').text(instanceIp);

						};
					case '/home/rtf/Desktop/RTF/rtf.log':
						return function(e){
							var resultString = e.target.result;
							rtfLog = resultString;
							var datas = rtfLog.split("\n");
							var tba = "";
							for (var i = 0; i < datas.length; i++) {
								if (datas[i] !== "") {
									tba += '<li class="list-group-item">' + htmlEncode(datas[i]) + '</li>';
								}
							}
							$('#rtfLogText').append(tba);
							diff2htmlUi.highlightCode('#rtfLogText');
							diff2htmlUi.highlightCode('.list-group-item');

						};
					case '/home/rtf/Desktop/RTF/selfcheck.json':
						return function(e){
							var resultString = e.target.result;
							var obj = JSON.parse(resultString);
							for(var i in obj){
								var status = obj[i];
								var vulnStatus = '<p style="color:red">Vulnerable</p>';
								if(!status)
									vulnStatus = '<p style="color:green">Not Vulnerable</p>';
								row = '<tr><td>'+i+'</td><td>'+vulnStatus+'</td>';
								$('#vulnTable').append(row);
							}
							$('#vulnerabilitiesTable').dynatable({
		                        features: {
		                            paginate: false,
		                            recordCount: false,
		                            pushState: false,
		                            search:false,
		                            sort:true
		                        }
		                    });
						};	
						
					}
					
					
				})(blob,fileName);
				reader.readAsBinaryString(blob);
			});
		}

		if (typeof requestFileSystem == "undefined")
			creationMethodInput.options.length = 1;
		fileInput.addEventListener('change', function() {
			$('#uploadArea').hide();
			$('#logArea').hide();
			$('#infoArea').show();
			model.getEntries(fileInput.files[0], function(entries) {
				entries.forEach(function(entry) {
					renderZippedFile(entry);
				});
			});
		}, false);
	})();

})(this);

$('#viewLogsButton').on('click',function(e){
	e.preventDefault();
	$('#uploadArea').hide();
	$('#diffDiv').hide();
	$('#viewLogsButton').hide();
	$('#viewDiffButton').show();
	$('#infoArea').show();
	$('#logArea').show();
	
});

$('#viewDiffButton').on('click',function(e){
	e.preventDefault();
	$('#uploadArea').hide();
	$('#logArea').hide();
	$('#viewDiffButton').hide();
	$('#viewLogsButton').show();
	$('#diffDiv').show();
	$('#infoArea').show();
	
});


</script>
</body>
</html>